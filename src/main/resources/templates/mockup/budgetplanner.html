<th:block th:replace="~{layout/base :: html(
    title='Budget Planner - Personal Finance Tracker',
    bodyClass='bg-gray-100',
    content=~{::content},
    extraHead=~{},
    extraScripts=~{::extraScripts}
)}">
    <th:block th:fragment="content">
        <div class="container mx-auto px-4 py-8">
            <h1 class="text-3xl font-bold mb-8">Budget Planner</h1>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Budget Setting Section -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">Set Category Budgets</h2>
                <form id="budgetForm" class="space-y-4">
                    <div id="categoryBudgets">
                        <!-- Category budget inputs will be dynamically added here -->
                    </div>
                    <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">Save Budgets</button>
                </form>
            </div>

            <!-- Budget Overview Section -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">Budget Overview</h2>
                <div class="h-64">
                    <canvas id="budgetChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Monthly Spending Breakdown -->
        <div class="mt-8 bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4">Monthly Spending Breakdown</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr>
                            <th class="pb-4 font-semibold">Category</th>
                            <th class="pb-4 font-semibold">Budget</th>
                            <th class="pb-4 font-semibold">Spent</th>
                            <th class="pb-4 font-semibold">Remaining</th>
                        </tr>
                    </thead>
                    <tbody id="spendingBreakdown">
                        <!-- Spending breakdown rows will be dynamically added here -->
                       </tbody>
                    </table>
                </div>
            </div>
        </div>
    </th:block>

    <th:block th:fragment="extraScripts">
        <script>
        // Fetch categories and populate budget form
        async function fetchCategories() {
            const response = await fetch('/cats');
            const categories = await response.json();
            const categoryBudgets = document.getElementById('categoryBudgets');
            
            categories.forEach(category => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label class="block mb-2">${category.name}</label>
                    <input type="number" name="budget_${category.id}" class="w-full border rounded px-3 py-2" placeholder="Set budget">
                `;
                categoryBudgets.appendChild(div);
            });
        }

        // Fetch monthly analytics and update chart
        async function updateBudgetChart() {
            const response = await fetch('/analytics/monthly');
            const data = await response.json();
            
            const ctx = document.getElementById('budgetChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Income', 'Expenses', 'Savings'],
                    datasets: [{
                        label: 'Amount',
                        data: [data.totalIncome, data.totalExpenses, data.totalSavings],
                        backgroundColor: ['#34D399', '#F87171', '#60A5FA']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // Update spending breakdown table
        function updateSpendingBreakdown(budgets, spending) {
            const tbody = document.getElementById('spendingBreakdown');
            tbody.innerHTML = '';

            for (const [category, budget] of Object.entries(budgets)) {
                const spent = spending[category] || 0;
                const remaining = budget - spent;
                const row = `
                    <tr>
                        <td class="py-2">${category}</td>
                        <td class="py-2">$${budget.toFixed(2)}</td>
                        <td class="py-2">$${spent.toFixed(2)}</td>
                        <td class="py-2 ${remaining >= 0 ? 'text-green-600' : 'text-red-600'}">$${remaining.toFixed(2)}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            }
        }

        // Initialize page
        async function init() {
            await fetchCategories();
            await updateBudgetChart();

            // Mock data for spending breakdown
            const mockBudgets = {
                'Groceries': 500,
                'Utilities': 200,
                'Entertainment': 150
            };
            const mockSpending = {
                'Groceries': 450,
                'Utilities': 180,
                'Entertainment': 200
            };
            updateSpendingBreakdown(mockBudgets, mockSpending);
        }

        // Form submission handler
        document.getElementById('budgetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const budgets = Object.fromEntries(formData);
            console.log('Budgets set:', budgets);
            // Here you would typically send this data to the server
            // await fetch('/set-budgets', { method: 'POST', body: formData });
        });

        init();
        </script>
    </th:block>
</th:block>
